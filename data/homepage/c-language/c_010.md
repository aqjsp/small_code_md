# C语言高级主题：工程实践

目标：掌握多文件组织、库的构建与链接、跨平台可移植性、编译优化与调试工具链；提供工程化最佳实践。

## 1. 多文件与库
- 静态库与动态库：ar/ld 或平台工具；Windows下 .lib/.dll，Linux下 .a/.so
- 导出与隐藏符号：extern 与 static；链接可见性控制（编译器属性）
- 头文件API设计：最小暴露、清晰文档、版本化、错误码体系

## 2. 模块化
- 头文件：声明 vs 定义；前向声明减少依赖
- 链接：extern, static

## 3. 构建系统
- Makefile：rules, variables, phony targets
- CMake：project, add_executable, target_link_libraries
- 编译器选项：-Wall -Wextra -Werror -O2/-O3 -g -fsanitize=address,undefined,thread
- 条件编译处理平台差异；封装平台接口

## 4. 可移植性
- 平台差异：endianness (htons), sizeof, signedness
- 条件编译：#ifdef __linux__ etc.

## 5. 调试与分析
- 调试：gdb/lldb；断点、回溯、观察点
- 静/动分析：clang-tidy、cppcheck（也适用于C）、valgrind/asan/ubsan
- 性能分析：perf/gprof、采样与插桩、剖析热点

## 6. 最佳实践
- 代码风格：consistent naming, comments
- 错误处理：check returns, use errno
- 安全：bounds checking, no buffer overflows
- CI：GitHub Actions for build/test

## 7. 练习
- 写Makefile多文件项目。
- 用CMake构建库。
- 调试内存泄漏用valgrind。

## 更多练习参考答案
- Makefile：dependencies, clean target。
- CMake：install, tests with ctest。
- valgrind：fix leaks in sample code。

## 更多示例

示例A：最小Makefile（含asan/ubsan）
```make
CC=gcc
CFLAGS=-Wall -Wextra -O2 -g
SAN=-fsanitize=address,undefined
LDFLAGS=$(SAN)

all: app
app: main.o util.o
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

%.o: %.c
	$(CC) $(CFLAGS) $(SAN) -c $< -o $@

clean:
	rm -f *.o app
```

示例B：最小CMake（静态库+可执行）
```cmake
cmake_minimum_required(VERSION 3.16)
project(demo C)
set(CMAKE_C_STANDARD 11)
add_library(mylib STATIC util.c)
add_executable(app main.c)
target_link_libraries(app PRIVATE mylib)
if (MSVC)
  target_compile_options(app PRIVATE /W4)
else()
  target_compile_options(app PRIVATE -Wall -Wextra -Wpedantic)
endif()
```

示例C：跨平台封装（路径与换行）
```c
#ifdef _WIN32
  #define EOL "\r\n"
#else
  #define EOL "\n"
#endif
```

示例D：调试与日志
```c
#include <stdio.h>
#ifdef DEBUG
#  define LOG(fmt, ...) fprintf(stderr, "[DBG] %s:%d: " fmt "\n", __FILE__, __LINE__, __VA_ARGS__)
#else
#  define LOG(fmt, ...)
#endif
```

示例E：Sanitizer运行
- 编译：gcc -g -fsanitize=address,undefined -O1 -fno-omit-frame-pointer main.c -o app
- 运行：ASAN_OPTIONS=detect_leaks=1 ./app

示例F：CI建议
- 在CI中启用 -Wall -Wextra -Werror，运行单元测试与Sanitizer构建。
- 不同平台（Windows/Linux/macOS）矩阵编译，验证可移植性。

## 参考资料
- CMake 官方文档与Modern CMake最佳实践。
- GCC/Clang 编译选项与Sanitizer文档；MSVC对应选项与调试指南。
- 跨平台实践：文件路径/编码/套接字API差异与适配策略。