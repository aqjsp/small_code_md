# C标准库与常用接口：从工具箱到实践

目标：熟悉C标准库各模块及常用函数：stdlib、string、ctype、math、time、errno、assert；了解使用规范与陷阱。

## 1. stdlib.h
- 内存管理：malloc/calloc/realloc/free
- 转换：atoi/atof/strtol (安全版检查错误)
- 内存：malloc/free；qsort/bsearch
- 杂项：rand/srand；exit/abort
- 陷阱：atoi无错误检测；rand低质量随机
- 排序与搜索：qsort/bsearch
- 进程控制：exit/atexit/system（system需谨慎，可能存在安全风险）

## 2. string.h 与 ctype.h
- 拷贝/拼接：memcpy/memmove/strcpy/strncpy/strcat/strncat
- 查找：strchr/strstr/memchr
- 比较：strcmp/strncmp/memcmp
- 字符分类与转换：isalpha/isdigit/tolower/toupper（注意unsigned char与EOF）

## 3. math.h
- 常用数学函数：sin/cos/tan/sqrt/pow/exp/log
- 浮点比较与误差：使用fabs与容差；NaN与Inf处理

## 4. time.h
- 时间获取与格式化：time/localtime/gmtime/strftime
- 计时：clock 或 C11 的 timespec/gettimeofday（平台相关）

## 5. errno 与 assert
- 错误码：errno；配合perror或strerror输出
- 断言：assert 只在NDEBUG未定义时生效

示例：
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int cmp_int(const void *a, const void *b) {
    int x = *(const int*)a, y = *(const int*)b;
    return (x>y) - (x<y);
}

int main(void) {
    int arr[] = {5,1,4,2,3};
    qsort(arr, 5, sizeof arr[0], cmp_int);
    for (int i=0;i<5;++i) printf("%d ", arr[i]);
    return 0;
}
```

## 6. 练习
- 使用strtol解析命令行参数，处理非法输入与范围。
- 写一个基准测试，测量不同字符串拷贝方法的耗时。
- 用qsort对结构体数组排序，按多个键比较。

## 更多示例

示例A：使用strtol健壮解析整数
```c
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <limits.h>

long parse_long(const char *s, int base){
    errno = 0;
    char *end = NULL;
    long v = strtol(s, &end, base);
    if (s == end) {
        fprintf(stderr, "no digits found: '%s'\n", s);
        return 0; // 视场景决定返回方式
    }
    if (errno == ERANGE || v > LONG_MAX || v < LONG_MIN) {
        perror("strtol");
        return 0;
    }
    while (*end == ' ' || *end == '\t') ++end; // 跳过尾随空白
    if (*end != '\0') {
        fprintf(stderr, "trailing chars: '%s'\n", end);
    }
    return v;
}
```

示例B：qsort对结构体数组进行多键排序
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct { char name[32]; int score; int age; } Person;

int cmp_person(const void *a, const void *b){
    const Person *pa = (const Person*)a;
    const Person *pb = (const Person*)b;
    if (pa->score != pb->score) return (pb->score - pa->score); // 分数降序
    int namecmp = strcmp(pa->name, pb->name);
    if (namecmp) return namecmp;                               // 名字升序
    return (pa->age - pb->age);                                 // 年龄升序
}

int main(void){
    Person arr[] = {{"Bob",90,20},{"Alice",95,19},{"Bob",90,18}};
    qsort(arr, 3, sizeof arr[0], cmp_person);
    for (int i=0;i<3;++i) printf("%s %d %d\n", arr[i].name, arr[i].score, arr[i].age);
}
```

示例C：ctype使用unsigned char避免UB
```c
#include <ctype.h>
#include <stdio.h>

int is_word_char(unsigned char c){
    return isalnum(c) || c=='_';
}

int main(void){
    signed char c = (signed char)0xE9; // 在某些平台是负值
    // 错误：isalpha(c) 可能UB
    printf("%d\n", isalpha((unsigned char)c)!=0); // 正确：先转为unsigned char
}
```

示例D：时间获取与格式化，以及简单计时
```c
#include <time.h>
#include <stdio.h>

int main(void){
    time_t t = time(NULL);
    struct tm lt; localtime_s(&lt, &t); // Windows; POSIX可用 localtime_r
    char buf[64]; strftime(buf, sizeof buf, "%Y-%m-%d %H:%M:%S", &lt);
    printf("now=%s\n", buf);

    clock_t beg = clock();
    // ... 执行需要计时的代码 ...
    clock_t end = clock();
    double seconds = (double)(end-beg)/CLOCKS_PER_SEC;
    printf("elapsed=%.6f s\n", seconds);
}
```

示例E：errno与assert
```c
#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <assert.h>

int main(void){
    FILE *fp = fopen("/path/not/exist","r");
    if(!fp){
        fprintf(stderr, "open failed: %s\n", strerror(errno));
    }
    int x = 5;
    assert(x>0); // 定义NDEBUG则不会检查
}
```

## 练习参考答案（节选）
- 使用strtol解析：检查endptr与errno，拒绝尾随非空白字符，处理范围与进制。
- 字符串拷贝基准：使用clock测量多次循环，分别对memcpy/strcpy/strncpy进行测试，确保避免编译器优化（如使用volatile或结果校验）。
- 结构体排序：定义比较器，先比主键（如score），再比次键（如name、age），保持返回负/零/正的语义。

## 参考资料
- C 标准库参考（string/stdlib/ctype/time/errno/assert）。
- 关于ctype与unsigned char的要求：传参需为unsigned char或EOF。
- strtol/qsort/strftime用法的权威参考文档与实现细节说明。
- 示例A：安全字符串拷贝
```c
char dst[10]; strncpy(dst, src, sizeof(dst)-1); dst[sizeof(dst)-1]=0;
```

示例B：qsort使用
```c
int cmp(const void* a, const void* b){ return *(int*)a - *(int*)b; }
qsort(arr, n, sizeof(int), cmp);
```

## 更多练习参考答案
- atoi：strtol with endptr check.
- qsort：define cmp func for struct field.
- 日志：time(NULL), localtime, strftime.