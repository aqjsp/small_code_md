# C语言高级主题

目标：理解C的抽象机器与内存模型，识别未定义/未指定/实现定义行为；了解C11原子与线程基础概念。

## 1. 内存模型
- 抽象机器：程序行为基于as-if规则优化
- 严格别名：不同类型指针别名UB，除char/unsigned char

## 2. 未定义/未指定/实现定义行为
- UB：signed overflow, null deref, data race
- 未指定：函数参数求值顺序
- 实现定义：sizeof(int), right shift signed

## 3. 序列规则
- 序列点：完整表达式末尾, &&/||, ?:, comma, func call
- 避免序列点间多次修改同一对象

## 4. C11并发
- 线程：thrd_create/thrd_join (threads.h)
- 原子：_Atomic int; atomic_store/load
- 同步：mtx_lock/unlock; cnd_wait/signal

## 5. 实用建议
- 避免UB：检查边界, 使用unsigned for bit ops
- 工具：-fsanitize=undefined, valgrind

## 6. 示例
示例A：数据竞争
```c
// 无同步多线程修改共享变量 -> UB
```

示例B：原子使用
```c
#include <stdatomic.h>
atomic_int count = 0;
atomic_fetch_add(&count, 1);
```

## 7. 练习
- 识别代码中UB。
- 实现线程安全计数器。
- 比较有/无原子性能。

## 更多练习参考答案
- UB：i = i++ ; signed overflow。
- 计数器：用mutex保护或atomic。
- 性能：基准测试循环增量。