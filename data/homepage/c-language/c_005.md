# C语言复合类型：struct, union, enum

目标：熟悉结构体、联合与枚举的语法与语义，掌握对齐与填充、位域、灵活数组成员、初始化与拷贝规则。

## 1. struct
- 定义：struct Point {int x,y;};
- 初始化：struct Point p = {1,2}; 或指定初始化 .x=1
- 匿名struct (C11)；嵌套。
- 对齐/填充：sizeof可能大于成员和；使用offsetof查看。

## 2. union
- 定义：union Variant {int i; float f;};
- 共享内存；类型双关需小心严格别名规则。
- 匿名union (C11)；用于变体类型模拟。

## 3. enum
- 定义：enum Color {RED=1, GREEN, BLUE};
- 底层类型：C11可指定 enum E : short {};
- 作用域：C无，但可前缀模拟 enum class。

## 4. 位字段与灵活数组
- 位字段：struct Flags {unsigned a:1, b:3;}; 打包但移植性差。
- 灵活数组成员：struct Buf {size_t len; char data[];}; 使用malloc(sizeof(struct Buf) + extra)。

示例：
```c
#include <stdio.h>
#include <stdlib.h>

typedef struct {
    size_t len;
    int data[]; // 灵活数组成员
} IntVec;

IntVec* intvec_new(size_t n) {
    IntVec *p = malloc(sizeof *p + n * sizeof(int));
    if (!p) return NULL;
    p->len = n;
    return p;
}
```

## 5. 示例
示例A：指定初始化
```c
struct Config {int a; char* b; double c;} cfg = {.a=10, .c=3.14, .b="hello"};
```

示例B：union类型双关
```c
union {float f; uint32_t u;} x; x.f=1.0; printf("%x", x.u); // 注意endian
```

## 6. 练习
- 实现带位字段的IP地址struct。
- 写union模拟变体（带标签）。
- 使用灵活数组创建动态字符串。

## 更多练习参考答案
- IP：struct IP {unsigned a:8, b:8, c:8, d:8;};
- 变体：enum Type {INT,FLOAT}; union Data {int i; float f;}; struct Var {enum Type t; union Data d;};
- 动态字符串：malloc(sizeof(struct Buf) + len +1); memcpy(data, str, len); data[len]=0;